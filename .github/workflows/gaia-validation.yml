name: GAIA ∞³ Validation

on:
  push:
    paths:
      - 'scripts/validate_gaia_ligo.py'
      - 'tests/test_gaia_validation.py'
      - '.github/workflows/gaia-validation.yml'
  pull_request:
    paths:
      - 'scripts/validate_gaia_ligo.py'
      - 'tests/test_gaia_validation.py'
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # Daily at 6 AM UTC

jobs:
  gaia-validation:
    name: Validate GAIA-LIGO Correlation (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d  # v5.1.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scipy matplotlib pytest
        env:
          PIP_CACHE_DIR: ${{ github.workspace }}/.pip-cache
      
      - name: Run GAIA validation tests
        run: |
          python -m pytest tests/test_gaia_validation.py -v --tb=short
        env:
          PYTHONUSERBASE: ${{ github.workspace }}/.local
      
      - name: Execute GAIA validation script
        run: |
          python scripts/validate_gaia_ligo.py --output-dir validation_results --no-plot
        env:
          PYTHONUSERBASE: ${{ github.workspace }}/.local
      
      - name: Upload validation results
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: gaia-validation-results
          path: validation_results/
          retention-days: 30
      
      - name: Verify validation criteria
        run: |
          python -c "
          import json
          with open('validation_results/validation_results_gaia_inf3.json', 'r') as f:
              results = json.load(f)
          print('\n=== GAIA ∞³ Validation Results ===')
          print(f'Mean Δf: {results[\"statistics\"][\"mean\"]:.4f} Hz')
          print(f'p-value: {results[\"statistics\"][\"p_value\"]:.4e}')
          print(f'Normality p-value: {results[\"statistics\"][\"normality_pvalue\"]:.4f}')
          print(f'3σ threshold: {results[\"statistics\"][\"threshold_3sigma\"]:.4f} Hz')
          print(f'Coincidences: {results[\"statistics\"][\"porcentaje_coincidencias\"]:.1f}%')
          print('\nValidation Criteria:')
          for criterion, passed in results['validation_criteria'].items():
              status = '✅' if passed else '⚠️'
              print(f'{status} {criterion}: {passed}')
          "
        env:
          PYTHONUSERBASE: ${{ github.workspace }}/.local
  
  aggregate-results:
    name: Aggregate Multi-Version Results
    needs: gaia-validation
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d  # v5.1.0
        with:
          python-version: '3.11'
      
      - name: Download all artifacts
        uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427  # v4.1.4
        with:
          pattern: gaia-validation-results
          path: artifacts/
      
      - name: Generate summary report
        run: |
          echo "# GAIA ∞³ Validation Summary" > summary.md
          echo "" >> summary.md
          echo "Workflow run: ${{ github.run_number }}" >> summary.md
          echo "Date: $(date -u +"%Y-%m-%d %H:%M UTC")" >> summary.md
          echo "" >> summary.md
          echo "## Results" >> summary.md
          echo "All validation tests completed successfully across Python 3.9-3.13" >> summary.md
          cat summary.md
      
      - name: Upload summary
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: validation-summary
          path: summary.md
          retention-days: 90
