name: Python Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10']
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy scipy matplotlib
        pip install pytest pytest-cov
        # Instalar dependencias b√°sicas sin Sage para CI
        if [ -f requirements_ci.txt ]; then pip install -r requirements_ci.txt; fi
    
    - name: Run basic tests
      run: |
        python tests/test_basic_functionality.py
    
    - name: Run CI-safe tests
      run: |
        python tests/test_ci_safe.py
    
    - name: Verify README LaTeX syntax
      run: |
        python tests/test_readme_latex.py
    
    - name: Run pytest on basic tests
      run: |
        pytest tests/test_finiteness_basic.py -v
        pytest tests/test_basic_functionality.py -v
        pytest tests/test_readme_latex.py -v
    
    - name: Test imports
      run: |
        python -c "
        try:
            import src
            print('‚úÖ Importaci√≥n b√°sica: OK')
        except ImportError as e:
            if 'sage' in str(e).lower():
                print('‚ö†Ô∏è  SageMath no disponible (esperado en CI)')
            else:
                raise
        "
    
    - name: Verify file structure
      run: |
        echo "Verificando estructura de archivos..."
        [ -f "src/spectral_finiteness.py" ] && echo "‚úÖ spectral_finiteness.py encontrado" || echo "‚ùå spectral_finiteness.py no encontrado"
        [ -f "README.md" ] && echo "‚úÖ README.md encontrado" || echo "‚ùå README.md no encontrado"
        [ -d "tests" ] && echo "‚úÖ Directorio tests encontrado" || echo "‚ùå Directorio tests no encontrado"
    
    - name: Run mathematical tests (si Sage est√° disponible)
      run: |
        # Solo ejecutar tests matem√°ticos si Sage est√° disponible
        if command -v sage &> /dev/null; then
          echo "SageMath disponible, ejecutando tests matem√°ticos"
          sage -python tests/test_finiteness.py
        else
          echo "SageMath no disponible, omitiendo tests matem√°ticos"
        fi

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Check documentation
      run: |
        [ -f "README.md" ] && echo "‚úÖ README existe" || exit 1
        [ -f "CONTRIBUTING.md" ] || echo "‚ö†Ô∏è  CONTRIBUTING.md no encontrado"
        echo "üìö Documentaci√≥n b√°sica: OK"
